name: Release maERP to Windows Store

on:
  workflow_dispatch:

jobs:
  windows-store-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Generate version
      id: version
      shell: pwsh
      run: |
        # Generate version in format: MAJOR.MINOR.BUILD.0 (Windows Store compliant)
        # Each part must be between 0-65535, last part reserved for Store (0)
        $year = Get-Date -Format "yyyy"
        $month = Get-Date -Format "MM"
        $day = Get-Date -Format "dd"
        $build = if ($env:GITHUB_RUN_NUMBER) { $env:GITHUB_RUN_NUMBER } else { "1" }
        
        # Calculate a Windows Store compliant version
        # Use year offset from 2020 to keep numbers small
        $yearOffset = [int]$year - 2020
        $majorVersion = $yearOffset
        $minorVersion = [int]$month * 100 + [int]$day  # MMDD format (e.g., 927 for Sept 27)
        $buildVersion = [int]$build
        $revisionVersion = 0  # Reserved for Store
        
        $version = "$majorVersion.$minorVersion.$buildVersion.$revisionVersion"
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Generated version: $version (Year offset: $yearOffset, Month-Day: $minorVersion, Build: $buildVersion)"

    - name: Restore dependencies
      run: dotnet restore src/maERP.UI.Desktop/maERP.UI.Desktop.csproj

    - name: Decode certificate
      shell: pwsh
      run: |
        $certBytes = [System.Convert]::FromBase64String("${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}")
        [System.IO.File]::WriteAllBytes("${{ github.workspace }}\certificate.pfx", $certBytes)

    - name: Build for Windows Store (MSIX)
      shell: pwsh
      run: |
        dotnet publish src/maERP.UI.Desktop/maERP.UI.Desktop.csproj --configuration Release --runtime win-x64 --self-contained false --output ./publish/msix -p:PublishSingleFile=false -p:PublishReadyToRun=false -p:Version="${{ steps.version.outputs.VERSION }}" -p:AssemblyVersion="${{ steps.version.outputs.VERSION }}" -p:FileVersion="${{ steps.version.outputs.VERSION }}" -p:UseAppHost=true

    - name: Create MSIX Package
      shell: pwsh
      run: |
        # Find the latest version of makeappx.exe in Windows SDK
        $winKitsPath = "C:\Program Files (x86)\Windows Kits\10\bin"
        if (-not (Test-Path $winKitsPath)) {
          Write-Error "Windows SDK path not found: $winKitsPath"
          exit 1
        }
        
        # Get all available SDK versions and find the latest one with makeappx.exe
        $sdkVersions = Get-ChildItem -Path $winKitsPath -Directory | 
                      Where-Object { $_.Name -match "^10\.0\.\d+\.\d+$" } |
                      Sort-Object { [version]($_.Name -replace "^10\.0\.","") } -Descending
        
        $fullMakeappxPath = $null
        foreach ($version in $sdkVersions) {
          $makeappxPath = Join-Path $version.FullName "x64\makeappx.exe"
          if (Test-Path $makeappxPath) {
            $fullMakeappxPath = $makeappxPath
            Write-Host "Found makeappx.exe at: $fullMakeappxPath (SDK version: $($version.Name))"
            break
          }
        }
        
        if (-not $fullMakeappxPath) {
          Write-Error "makeappx.exe not found in any Windows SDK version. Available SDK versions:"
          $sdkVersions | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        # Create Assets directory and placeholder assets
        New-Item -Path "./publish/msix/Assets" -ItemType Directory -Force
        
        # Create minimal placeholder PNG files (1x1 transparent pixel in base64)
        $transparentPixelBase64 = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAI9BfKSVQAAAABJRU5ErkJggg=="
        $transparentPixelBytes = [System.Convert]::FromBase64String($transparentPixelBase64)
        
        [System.IO.File]::WriteAllBytes("./publish/msix/Assets/StoreLogo.png", $transparentPixelBytes)
        [System.IO.File]::WriteAllBytes("./publish/msix/Assets/Square150x150Logo.png", $transparentPixelBytes)
        [System.IO.File]::WriteAllBytes("./publish/msix/Assets/Square44x44Logo.png", $transparentPixelBytes)
        [System.IO.File]::WriteAllBytes("./publish/msix/Assets/Wide310x150Logo.png", $transparentPixelBytes)
        
        # Create package manifest as AppxManifest.xml (required by MakeAppx)
        $manifestContent = @"
        <?xml version="1.0" encoding="utf-8"?>
        <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                 xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                 xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
          <Identity Name="MartinAndrich.maERP"
                    Publisher="CN=Martin Andrich"
                    Version="${{ steps.version.outputs.VERSION }}" />
          <Properties>
            <DisplayName>maERP</DisplayName>
            <PublisherDisplayName>Martin Andrich</PublisherDisplayName>
            <Logo>Assets\StoreLogo.png</Logo>
            <Description>Cross-platform ERP system</Description>
          </Properties>
          <Dependencies>
            <TargetDeviceFamily Name="Windows.Universal" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22000.0" />
          </Dependencies>
          <Applications>
            <Application Id="maERP" Executable="maERP.UI.Desktop.exe" EntryPoint="Windows.FullTrustApplication">
              <uap:VisualElements DisplayName="maERP"
                                  Description="Cross-platform ERP system"
                                  BackgroundColor="transparent"
                                  Square150x150Logo="Assets\Square150x150Logo.png"
                                  Square44x44Logo="Assets\Square44x44Logo.png">
                <uap:DefaultTile Wide310x150Logo="Assets\Wide310x150Logo.png" />
              </uap:VisualElements>
            </Application>
          </Applications>
          <Capabilities>
            <rescap:Capability Name="runFullTrust" />
          </Capabilities>
        </Package>
        "@
        
        $manifestContent | Out-File -FilePath "./publish/msix/AppxManifest.xml" -Encoding UTF8
        
        # Create MSIX package
        & $fullMakeappxPath pack /d "./publish/msix" /p "./maERP-${{ steps.version.outputs.VERSION }}.msix"

    - name: Sign MSIX Package
      shell: pwsh
      run: |
        # Find the latest version of signtool.exe in Windows SDK
        $winKitsPath = "C:\Program Files (x86)\Windows Kits\10\bin"
        if (-not (Test-Path $winKitsPath)) {
          Write-Error "Windows SDK path not found: $winKitsPath"
          exit 1
        }
        
        # Get all available SDK versions and find the latest one with signtool.exe
        $sdkVersions = Get-ChildItem -Path $winKitsPath -Directory | 
                      Where-Object { $_.Name -match "^10\.0\.\d+\.\d+$" } |
                      Sort-Object { [version]($_.Name -replace "^10\.0\.","") } -Descending
        
        $fullSigntoolPath = $null
        foreach ($version in $sdkVersions) {
          $signtoolPath = Join-Path $version.FullName "x64\signtool.exe"
          if (Test-Path $signtoolPath) {
            $fullSigntoolPath = $signtoolPath
            Write-Host "Found signtool.exe at: $fullSigntoolPath (SDK version: $($version.Name))"
            break
          }
        }
        
        if (-not $fullSigntoolPath) {
          Write-Error "signtool.exe not found in any Windows SDK version. Available SDK versions:"
          $sdkVersions | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        # Sign the package
        & $fullSigntoolPath sign /f "${{ github.workspace }}\certificate.pfx" /p "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" /fd SHA256 "./maERP-${{ steps.version.outputs.VERSION }}.msix"

    - name: Store Upload (Manual Process)
      shell: pwsh
      run: |
        Write-Host "=== MSIX Package Ready for Manual Store Submission ==="
        Write-Host "Package Location: ${{ github.workspace }}/maERP-${{ steps.version.outputs.VERSION }}.msix"
        Write-Host ""
        Write-Host "Manual Steps Required:"
        Write-Host "1. Download the MSIX package from GitHub Release"
        Write-Host "2. Sign in to Microsoft Partner Center"
        Write-Host "3. Navigate to your maERP app submission"
        Write-Host "4. Upload the MSIX package"
        Write-Host "5. Complete certification and publishing process"
        Write-Host ""
        Write-Host "Note: Automated Store API integration requires additional setup"
        Write-Host "and Microsoft Partner Center API credentials configuration."

    - name: Create GitHub Release with MSIX
      uses: softprops/action-gh-release@v2
      with:
        tag_name: store-v${{ steps.version.outputs.VERSION }}
        name: maERP Windows Store v${{ steps.version.outputs.VERSION }}
        body: |
          ## maERP Windows Store Release v${{ steps.version.outputs.VERSION }}
          
          Automatisch erstelltes Windows Store Release der maERP Desktop-Anwendung.
          
          ### MSIX Package
          - **Windows Store Package**: `maERP-${{ steps.version.outputs.VERSION }}.msix`
          
          ### Installation
          Das Package wurde automatisch an den Microsoft Store Ã¼bermittelt.
          
          ---
          
          ðŸ¤– Automatisch erstellt durch GitHub Actions
        draft: false
        prerelease: false
        files: |
          maERP-${{ steps.version.outputs.VERSION }}.msix
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      shell: pwsh
      run: |
        Remove-Item "${{ github.workspace }}\certificate.pfx" -Force -ErrorAction SilentlyContinue